<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Innovación | Gestión Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .priority-btn.active-high { background-color: #ef4444 !important; color: white !important; }
        .priority-btn.active-medium { background-color: #f59e0b !important; color: white !important; }
        .priority-btn.active-low { background-color: #10b981 !important; color: white !important; }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos para Drag & Drop */
        .draggable-card { cursor: grab; transition: transform 0.2s, box-shadow 0.2s; }
        .draggable-card:active { cursor: grabbing; transform: scale(1.02); }
        .trash-zone-active { background-color: #fee2e2 !important; border-color: #ef4444 !important; transform: scale(1.02); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-blue-50 min-h-screen flex flex-col">

    <header class="bg-white shadow-sm border-b border-blue-100 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">I</div>
                <span class="font-bold text-slate-800 text-lg hidden md:block">DEP. INVESTIGACIÓN E INNOVACIÓN</span>
            </div>
            <nav class="flex space-x-1" aria-label="Navegación principal">
                <button onclick="switchTab('registro')" id="tab-registro" class="px-4 py-2 rounded-lg font-medium text-sm transition-all bg-blue-50 text-blue-700">Registro</button>
                <button onclick="switchTab('fichas')" id="tab-fichas" class="px-4 py-2 rounded-lg font-medium text-sm transition-all text-slate-600 hover:bg-slate-50">Fichas</button>
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="px-4 py-2 rounded-lg font-medium text-sm transition-all text-slate-600 hover:bg-slate-50">Dashboard</button>
            </nav>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-6 flex-grow">
        
        <div id="registro-view" class="space-y-6 animate-fade-in">
            <div class="bg-white p-4 rounded-2xl shadow-lg border border-blue-100 flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-1 w-full">
                    <label for="busquedaCedula" class="text-xs font-bold text-slate-500 uppercase ml-2">Consultar Registro por Cédula</label>
                    <div class="relative">
                        <input type="text" id="busquedaCedula" placeholder="000-0000000-0" 
                            class="w-full pl-4 pr-12 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono">
                        <button onclick="buscarPorCedula()" class="absolute right-2 top-2 p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div id="search-results" class="hidden bg-white p-6 rounded-2xl shadow-lg border border-blue-100">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Resultados de búsqueda</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-xs font-bold text-slate-400 uppercase border-b">
                                <th class="pb-3">Proyecto</th>
                                <th class="pb-3">Responsable</th>
                                <th class="pb-3">Regional</th>
                                <th class="pb-3 text-right">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-white/20 glass">
                <div class="bg-slate-900 p-8 text-white relative">
                    <div class="relative z-10">
                        <h1 class="text-3xl font-extrabold tracking-tight">Innova Proyectos</h1>
                        <p class="text-slate-400 mt-2 font-medium">SCR Seguimiento Centralizado por Regionales</p>
                    </div>
                </div>

                <form id="innovationForm" class="p-8 space-y-8">
                    <input type="hidden" id="recordId" value="">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Regional / Sede *</label>
                            <select id="regional" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none">
                                <option value="">Seleccione...</option>
                                <option value="Cibao Norte">Cibao Norte</option>
                                <option value="Cibao Sur">Cibao Sur</option>
                                <option value="Oriental">Oriental</option>
                                <option value="Metropolitana">Metropolitana</option>
                                <option value="Norte">Regional Norte</option>
                                <option value="Sur">Regional Sur</option>
                                <option value="Este">Regional Este</option>
                                <option value="ECI">ECI</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Taller Responsable *</label>
                            <select id="taller" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none">
                                <option value="">Seleccione Taller...</option>
                                <option value="Electrónica">Electrónica</option>
                                <option value="Informática">Informática</option>
                                <option value="Mecánica">Mecánica</option>
                                <option value="Mecánica Industrial">Mecánica Industrial</option>
                                <option value="Gastronomía y Hotelería">Gastronomía y Hotelería</option>
                                <option value="Ebanistería">Ebanistería</option>
                                <option value="Salud y bienestar">Salud y bienestar</option>
                                <option value="Artes Gráficas">Artes Gráficas</option>
                                <option value="Electricidad">Electricidad</option>
                                <option value="Confecion y diseño">Confeccion</option>
                                <option value="Ebanisteria">Ebanisteria</option>
                                <option value="Desabolladura y pintura">Desabolladura y pintura</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Nombre del Proyecto *</label>
                                <input type="text" id="nombreProyecto" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Cédula del Responsable *</label>
                                <input type="text" id="cedula" required placeholder="000-0000000-0" class="w-full bg-blue-50 border-2 border-blue-100 rounded-xl p-3 outline-none font-bold text-blue-800">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Nombre Responsable</label>
                                <input type="text" id="responsable" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Teléfono</label>
                                <input type="tel" id="telefono" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Correo</label>
                                <input type="email" id="email" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6 bg-blue-50/50 rounded-2xl border border-blue-100">
                        <div>
                            <label class="block text-sm font-bold text-blue-800 mb-2">Fecha Último Seguimiento *</label>
                            <input type="date" id="fechaSeguimiento" required class="w-full bg-white border border-blue-200 rounded-xl p-3 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-blue-800 mb-2">Prioridad</label>
                            <div class="flex gap-2">
                                <button type="button" onclick="setPriority('Baja')" class="priority-btn flex-1 py-2 rounded-lg border-2 border-slate-200 font-bold text-slate-500 bg-white text-xs">Baja</button>
                                <button type="button" onclick="setPriority('Media')" class="priority-btn flex-1 py-2 rounded-lg border-2 border-slate-200 font-bold text-slate-500 bg-white text-xs">Media</button>
                                <button type="button" onclick="setPriority('Alta')" class="priority-btn flex-1 py-2 rounded-lg border-2 border-slate-200 font-bold text-slate-500 bg-white text-xs">Alta</button>
                            </div>
                            <input type="hidden" id="prioridad" value="">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Recomendaciones y Mejoras</label>
                        <textarea id="recomendaciones" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none"></textarea>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                            <label class="font-bold text-slate-700">Estado de Avance</label>
                            <span id="progresoValor" class="bg-slate-900 text-white px-4 py-1 rounded-full text-sm font-bold">0%</span>
                        </div>
                        <input type="range" id="progreso" min="0" max="100" value="0" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
                        <button type="button" onclick="resetForm()" class="py-4 px-6 rounded-xl font-bold text-blue-600 bg-blue-50 hover:bg-blue-100 transition-all">Nuevo Registro</button>
                        <button type="button" onclick="limpiarFormulario()" class="py-4 px-6 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition-all">Limpiar</button>
                        <button type="submit" id="btnGuardar" class="py-4 px-6 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-xl transition-all transform active:scale-95">Guardar Registro</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="fichas-view" class="hidden animate-fade-in h-[calc(100vh-140px)] flex flex-col md:flex-row gap-4">
            
            <div class="flex-1 bg-white p-6 rounded-2xl shadow-lg border border-blue-100 flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <div>
                        <h3 class="font-bold text-slate-800 text-xl">Tablero de Proyectos</h3>
                        <p class="text-xs text-slate-400">Arrastra las tarjetas a la papelera para eliminar</p>
                    </div>
                    <button onclick="cargarVistaFichas()" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg" title="Recargar Fichas">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                </div>
                
                <div id="grid-fichas" class="flex-1 overflow-y-auto pr-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 content-start" 
                     ondrop="drop(event, 'activo')" ondragover="allowDrop(event)">
                     <div class="text-center text-slate-400 col-span-full py-10">Cargando fichas...</div>
                </div>
            </div>
        
            <div class="md:w-1/4 w-full min-w-[280px] bg-slate-100 p-4 rounded-2xl border-2 border-dashed border-slate-300 flex flex-col transition-all duration-300"
                 id="zona-papelera"
                 ondrop="drop(event, 'papelera')" ondragover="allowDrop(event)">
                
                <div class="text-center mb-4 pointer-events-none">
                    <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-2 shadow-sm">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </div>
                    <h4 class="font-bold text-slate-700">Papelera de Reciclaje</h4>
                    <p class="text-xs text-slate-500">Suelta aquí para eliminar</p>
                </div>
        
                <div id="grid-papelera" class="flex-1 space-y-3 overflow-y-auto mb-4 p-2 bg-slate-200/50 rounded-xl border-inner shadow-inner">
                    </div>
        
                <button onclick="procesarEliminacion()" id="btn-vaciar" class="w-full py-3 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold shadow-lg opacity-50 cursor-not-allowed transition-all transform active:scale-95" disabled>
                    Vaciar Papelera
                </button>
            </div>
        </div>

        <div id="dashboard-view" class="hidden space-y-6 animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1">Total Proyectos</p>
                    <p id="stat-total" class="text-3xl font-extrabold text-blue-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1">Promedio Avance</p>
                    <p id="stat-avance" class="text-3xl font-extrabold text-emerald-600">0%</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1">Alta Prioridad</p>
                    <p id="stat-alta" class="text-3xl font-extrabold text-red-600">0</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100">
                    <p class="text-xs font-bold text-slate-500 uppercase mb-1">Regionales Activas</p>
                    <p id="stat-regionales" class="text-3xl font-extrabold text-slate-800">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100">
                    <h3 class="font-bold text-slate-800 mb-4">Proyectos por Regional</h3>
                    <div class="h-[300px] w-full relative">
                        <canvas id="chartRegionales"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100">
                    <h3 class="font-bold text-slate-800 mb-4">Proyectos por Taller</h3>
                    <div class="h-[300px] w-full relative">
                        <canvas id="chartTalleres"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border border-blue-100 mt-6">
                <h3 class="font-bold text-slate-800 mb-4">Listado de Proyectos Registrados</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-xs font-bold text-slate-400 uppercase border-b">
                                <th class="pb-3">Nombre del Proyecto</th>
                                <th class="pb-3">Responsable</th>
                                <th class="pb-3 text-right">Cédula</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-projects-list"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="api-alert" class="hidden bg-amber-50 border border-amber-200 p-4 rounded-xl text-amber-800 text-sm mt-6">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                    <span><strong>Nota:</strong> No se pudo recuperar el listado completo. Asegúrese de que el backend soporte la acción de lectura global.</span>
                </div>
            </div>
        </div>
    </main>

    <div id="global-loader" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="loader w-12 h-12 border-4 rounded-full mb-4"></div>
            <p class="font-bold text-slate-800">Procesando solicitud...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzMLSr8RG5yksGorBWK0biCrXHYQ4yqBwdFS3r8Bv3JrS4aNX-dqXruDCpk7z8r3z0/exec';
        let charts = {};
        
        // --- VARIABLES GLOBALES PARA FICHAS ---
        let proyectosGlobales = [];
        let proyectosAborrar = new Set();

        function switchTab(tab) {
            // Ocultar todo
            document.getElementById('registro-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('fichas-view').classList.add('hidden');
            
            // Resetear botones
            const baseClass = "px-4 py-2 rounded-lg font-medium text-sm transition-all text-slate-600 hover:bg-slate-50";
            const activeClass = "bg-blue-50 text-blue-700".split(" ");
            
            document.getElementById('tab-registro').className = baseClass;
            document.getElementById('tab-dashboard').className = baseClass;
            document.getElementById('tab-fichas').className = baseClass;

            // Activar selección
            if (tab === 'registro') {
                document.getElementById('registro-view').classList.remove('hidden');
                document.getElementById('tab-registro').classList.remove('text-slate-600');
                document.getElementById('tab-registro').classList.add(...activeClass);
            } else if (tab === 'dashboard') {
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('tab-dashboard').classList.remove('text-slate-600');
                document.getElementById('tab-dashboard').classList.add(...activeClass);
                actualizarDashboard(); 
            } else if (tab === 'fichas') {
                document.getElementById('fichas-view').classList.remove('hidden');
                document.getElementById('tab-fichas').classList.remove('text-slate-600');
                document.getElementById('tab-fichas').classList.add(...activeClass);
                cargarVistaFichas();
            }
        }

        // --- FUNCIONES DEL DASHBOARD Y CARGA DE DATOS ---

        async function actualizarDashboard() {
            toggleLoader(true);
            document.getElementById('api-alert').classList.add('hidden');
            try {
                const response = await fetch(scriptURL + '?action=readAll', { method: 'GET' });
                if (!response.ok) throw new Error("Error en la respuesta del servidor");
                const rawData = await response.json();
                
                const records = (rawData.status === 'success' && Array.isArray(rawData.data)) ? rawData.data : [];
                proyectosGlobales = records; // Guardar copia para Fichas
                
                renderDashboard(records);
            } catch (error) {
                console.error("Error dashboard:", error);
                document.getElementById('api-alert').classList.remove('hidden');
            } finally {
                toggleLoader(false);
            }
        }

        function renderDashboard(data) {
            const total = data.length;
            const avgAvance = total > 0 ? (data.reduce((acc, curr) => {
                const progStr = (curr.progreso || "0").toString().replace('%', '');
                return acc + (parseInt(progStr) || 0);
            }, 0) / total).toFixed(1) : 0;
            const altaPrioridad = data.filter(p => (p.prioridad || '').toLowerCase() === 'alta').length;
            const regionalesUnicas = new Set(data.map(p => p.regional).filter(r => r)).size;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-avance').innerText = `${avgAvance}%`;
            document.getElementById('stat-alta').innerText = altaPrioridad;
            document.getElementById('stat-regionales').innerText = regionalesUnicas;

            const regionalesCount = {};
            data.forEach(p => { const reg = p.regional || 'No especificada'; regionalesCount[reg] = (regionalesCount[reg] || 0) + 1; });
            renderChart('chartRegionales', 'bar', {
                labels: Object.keys(regionalesCount),
                datasets: [{ label: 'Proyectos', data: Object.values(regionalesCount), backgroundColor: 'rgba(37, 99, 235, 0.6)', borderColor: 'rgb(37, 99, 235)', borderWidth: 1 }]
            });

            const talleresCount = {};
            data.forEach(p => { const tall = p.taller || 'No especificado'; talleresCount[tall] = (talleresCount[tall] || 0) + 1; });
            renderChart('chartTalleres', 'doughnut', {
                labels: Object.keys(talleresCount),
                datasets: [{ data: Object.values(talleresCount), backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316'] }]
            });
            
            const listBody = document.getElementById('dashboard-projects-list');
            if (listBody) {
                listBody.innerHTML = '';
                data.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-slate-50 transition-colors";
                    tr.innerHTML = `
                        <td class="py-3 font-medium text-slate-700">${p.nombre || p.nombreProyecto || 'Sin nombre'}</td>
                        <td class="py-3 text-slate-600">${p.responsable || 'N/A'}</td>
                        <td class="py-3 text-right text-slate-600 font-mono text-sm">${p.cedula || 'N/A'}</td>
                    `;
                    listBody.appendChild(tr);
                });
            }
        }

        function renderChart(id, type, data) {
            if (charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, { type: type, data: data, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: type === 'doughnut' ? 'right' : 'top' } } } });
        }

        // --- FUNCIONES DEL MÓDULO DE FICHAS Y PAPELERA ---

        async function cargarVistaFichas() {
            // Si no tenemos datos, cargamos. Si tenemos, usamos caché local.
            if (proyectosGlobales.length === 0) {
                await actualizarDashboard(); // Esto llena proyectosGlobales
            }
            renderizarFichas();
        }

        function renderizarFichas() {
            const contenedorActivos = document.getElementById('grid-fichas');
            const contenedorPapelera = document.getElementById('grid-papelera');
            
            contenedorActivos.innerHTML = '';
            contenedorPapelera.innerHTML = '';

            if (proyectosGlobales.length === 0) {
                contenedorActivos.innerHTML = '<div class="text-center text-slate-400 col-span-full py-10">No hay proyectos registrados.</div>';
                actualizarBotonPapelera();
                return;
            }

            proyectosGlobales.forEach(p => {
                const esPapelera = proyectosAborrar.has(p.id.toString());
                const fichaHTML = crearHTMLFicha(p, esPapelera);
                
                if (esPapelera) {
                    contenedorPapelera.appendChild(fichaHTML);
                } else {
                    contenedorActivos.appendChild(fichaHTML);
                }
            });
            
            actualizarBotonPapelera();
        }

        function crearHTMLFicha(p, enPapelera) {
            const div = document.createElement('div');
            div.draggable = true;
            div.id = "card-" + p.id;
            div.ondragstart = (ev) => drag(ev, p.id);
            
            if (enPapelera) {
                // Estilo para ficha en Papelera
                div.className = "bg-white p-3 rounded-lg shadow-sm border-l-4 border-red-500 cursor-grab draggable-card opacity-80 text-sm flex justify-between items-center group";
                div.innerHTML = `
                    <div class="truncate flex-1">
                        <div class="font-bold text-red-800 truncate">${p.nombre || 'Sin nombre'}</div>
                        <div class="text-xs text-slate-500">${p.responsable}</div>
                    </div>
                    <div class="text-slate-300 group-hover:text-red-500 ml-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                `;
            } else {
                // Estilo para ficha Activa
                div.className = "bg-white p-4 rounded-xl shadow-md border border-slate-100 hover:shadow-lg transition-all draggable-card border-l-4 border-blue-500 relative group";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-slate-800 text-lg truncate pr-2">${p.nombre || 'Proyecto Nuevo'}</div>
                        <span class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">${p.regional || 'N/A'}</span>
                    </div>
                    <div class="text-slate-500 text-sm flex items-center mb-1">
                        <svg class="w-4 h-4 mr-1 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        ${p.responsable || 'Sin responsable'}
                    </div>
                    <div class="text-slate-500 text-sm flex items-center">
                        <svg class="w-4 h-4 mr-1 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        ${p.taller || 'Taller General'}
                    </div>
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-slate-300">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                    </div>
                `;
            }
            return div;
        }

        function allowDrop(ev) {
            ev.preventDefault();
            const zone = document.getElementById('zona-papelera');
            if (ev.currentTarget.id === 'zona-papelera') {
                zone.classList.add('trash-zone-active');
            }
        }

        function drag(ev, id) {
            ev.dataTransfer.setData("text", id);
        }

        function drop(ev, destino) {
            ev.preventDefault();
            const id = ev.dataTransfer.getData("text");
            const zone = document.getElementById('zona-papelera');
            zone.classList.remove('trash-zone-active');

            if (destino === 'papelera') {
                proyectosAborrar.add(id.toString());
            } else {
                // Sacar de la papelera
                proyectosAborrar.delete(id.toString());
            }
            renderizarFichas();
        }

        function actualizarBotonPapelera() {
            const btn = document.getElementById('btn-vaciar');
            if (proyectosAborrar.size > 0) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.classList.add('hover:bg-red-700', 'active:scale-95');
                btn.innerHTML = `Confirmar Eliminación (${proyectosAborrar.size})`;
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('hover:bg-red-700', 'active:scale-95');
                btn.innerHTML = "Vaciar Papelera";
            }
        }

        async function procesarEliminacion() {
            if (!confirm(`ADVERTENCIA: ¿Estás seguro de que deseas eliminar permanentemente ${proyectosAborrar.size} registro(s)? Esta acción no se puede deshacer.`)) return;

            toggleLoader(true);
            const idsParaBorrar = Array.from(proyectosAborrar);
            let errores = 0;

            // Procesar eliminaciones una por una
            for (const id of idsParaBorrar) {
                try {
                    const response = await fetch(scriptURL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'delete', id: id })
                    });
                    const res = await response.json();
                    if(res.status === 'error') errores++;
                } catch (e) {
                    console.error(e);
                    errores++;
                }
            }

            if (errores === 0) {
                showToast("✅ Registros eliminados correctamente");
                proyectosAborrar.clear();
                // Recargar datos frescos
                await actualizarDashboard();
                renderizarFichas();
            } else {
                showToast("⚠️ Hubo un error al eliminar algunos registros", "error");
                // Recargar para ver estado real
                await actualizarDashboard();
                renderizarFichas();
            }
            toggleLoader(false);
        }

        // --- FUNCIONES DE REGISTRO (EXISTENTES) ---

        function setPriority(level) {
            if (!level) return;
            const mapping = { 'baja': 'low', 'media': 'medium', 'alta': 'high' };
            const normalizedLevel = level.toLowerCase();
            const activeClass = mapping[normalizedLevel] || normalizedLevel;
            document.getElementById('prioridad').value = level;
            const buttons = document.querySelectorAll('.priority-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active-high', 'active-medium', 'active-low', 'text-white', 'bg-white');
                if(btn.innerText.toLowerCase() === normalizedLevel) {
                    btn.classList.add('active-' + activeClass, 'text-white');
                } else {
                    btn.classList.add('bg-white');
                }
            });
        }

        async function buscarPorCedula() {
            const cedulaBusqueda = document.getElementById('busquedaCedula').value.trim();
            if (!cedulaBusqueda) return showToast("Ingrese una cédula para buscar", "error");

            toggleLoader(true);
            const searchResults = document.getElementById('search-results');
            searchResults.classList.add('hidden');
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'search', buscarCedula: cedulaBusqueda })
                });
                const data = await response.json();
                
                const records = (data.status === 'success' || data.status === 'ok') ?
                (Array.isArray(data.data) ? data.data : (data.data ? [data.data] : [])) : [];
                
                if (records.length === 0) {
                    showToast("❌ No se encontró ningún registro con esa cédula.", "error");
                } else if (records.length === 1) {
                    cargarProyecto(records[0]);
                    showToast("✅ Registro encontrado.");
                } else {
                    mostrarListaProyectos(records);
                    showToast(`✅ Se encontraron ${records.length} proyectos.`);
                }
            } catch (error) {
                console.error(error);
                showToast("Error al conectar con la base de datos.", "error");
            } finally {
                toggleLoader(false);
            }
        }

        function mostrarListaProyectos(proyectos) {
            const searchResults = document.getElementById('search-results');
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '';
            proyectos.forEach((p) => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="py-3 font-medium text-slate-700">${p.nombre || p.nombreProyecto}</td>
                    <td class="py-3 text-slate-600">${p.responsable}</td>
                    <td class="py-3 text-slate-600">${p.regional}</td>
                    <td class="py-3 text-right">
                        <button onclick='cargarProyecto(${JSON.stringify(p).replace(/'/g, "&apos;")})'
                            class="px-3 py-1 bg-blue-100 text-blue-700 rounded-md text-sm font-bold hover:bg-blue-200">
                            Cargar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            searchResults.classList.remove('hidden');
            searchResults.scrollIntoView({ behavior: 'smooth' });
        }

        function cargarProyecto(p) {
            document.getElementById('recordId').value = p.id || '';
            document.getElementById('regional').value = p.regional || '';
            document.getElementById('taller').value = p.taller || '';
            document.getElementById('nombreProyecto').value = p.nombre || p.nombreProyecto || '';
            document.getElementById('cedula').value = p.cedula || '';
            document.getElementById('responsable').value = p.responsable || '';
            document.getElementById('telefono').value = p.telefono || '';
            document.getElementById('email').value = p.email || '';
            document.getElementById('fechaSeguimiento').value = p.fechaSeguimiento ? p.fechaSeguimiento.split('T')[0] : '';
            document.getElementById('recomendaciones').value = p.recomendaciones || '';
            const prog = (p.progreso || "0").toString().replace('%', '');
            document.getElementById('progreso').value = prog;
            document.getElementById('progresoValor').textContent = `${prog}%`;
            setPriority(p.prioridad || '');

            const btn = document.getElementById('btnGuardar');
            btn.innerText = "Actualizar Registro";
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.add('bg-orange-500', 'hover:bg-orange-600');

            document.getElementById('search-results').classList.add('hidden');
            showToast("Modo edición activado.");
        }

        document.getElementById('progreso').addEventListener('input', (e) => {
            document.getElementById('progresoValor').textContent = `${e.target.value}%`;
        });

        document.getElementById('innovationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            toggleLoader(true);
            
            const recordId = document.getElementById('recordId').value;
            const actionType = recordId ? 'update' : 'insert';

            const payload = {
                action: actionType,
                id: recordId,
                regional: document.getElementById('regional').value,
                taller: document.getElementById('taller').value,
                nombre: document.getElementById('nombreProyecto').value,
                nombreProyecto: document.getElementById('nombreProyecto').value,
                cedula: document.getElementById('cedula').value,
                responsable: document.getElementById('responsable').value,
                telefono: document.getElementById('telefono').value,
                email: document.getElementById('email').value,
                fechaSeguimiento: document.getElementById('fechaSeguimiento').value,
                prioridad: document.getElementById('prioridad').value,
                recomendaciones: document.getElementById('recomendaciones').value,
                progreso: document.getElementById('progreso').value
            };
            
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.status === 'error') {
                    showToast("⚠️ " + data.message, "error");
                } else {
                    const msg = actionType === 'update' ? '✅ Registro actualizado correctamente.' : '✅ Registro creado satisfactoriamente.';
                    showToast(msg);
                    limpiarFormulario();
                    actualizarDashboard();
                }
            } catch (err) {
                console.error(err);
                showToast('Error de conexión: ' + err.message, 'error');
            } finally {
                toggleLoader(false);
            }
        });

        function limpiarFormulario() {
            document.getElementById('innovationForm').reset();
            document.getElementById('recordId').value = '';
            const btn = document.getElementById('btnGuardar');
            btn.innerText = "Guardar Registro";
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            document.getElementById('progresoValor').textContent = '0%';
            setPriority('');
        }

        function resetForm() {
            limpiarFormulario();
            document.getElementById('busquedaCedula').value = '';
            document.getElementById('search-results').classList.add('hidden');
            showToast("Formulario listo para nuevo registro.");
        }

        function toggleLoader(show) {
            const loader = document.getElementById('global-loader');
            if (show) {
                loader.classList.remove('hidden');
                loader.classList.add('flex');
            } else {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-xl shadow-2xl text-white font-bold transform transition-all translate-y-10 opacity-0 z-[100] ${type === 'success' ? 'bg-emerald-600' : 'bg-red-600'}`;
            toast.innerText = message;
            document.body.appendChild(toast);

            setTimeout(() => { toast.classList.remove('translate-y-10', 'opacity-0'); }, 100);
            setTimeout(() => { toast.classList.add('translate-y-10', 'opacity-0'); setTimeout(() => toast.remove(), 4000); }, 4000);
        }
    </script>
</body>
</html>